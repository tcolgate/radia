<!DOCTYPE html>
<!--
 Copyright (c) 2016 Tristan Colgate-McFarlane

 This file is part of vonq.

 vonq is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 vonq is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with vonq.  If not, see <http://www.gnu.org/licenses/>.
-->

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.15/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment-with-locales.min.js"></script>

<style type="text/css">
  .activeLink {
    stroke: #000;
    stroke-width: 1.5px;
  }

  .inactiveLink {
    stroke: #000;
    stroke-width: 0px;
  }

  .node {
    stroke: #000;
    stroke-width: 1.5px;
  }
</style>

<body>
  <script>
      var ws = new WebSocket("ws://localhost:12345/updates");

      var width = 960,
          height = 500;

      var c20c = d3.scale.category20c();

      var nodes = [],
          halfLinks = [],
          links = [];

      var nodesIdx = {}; // map node IDs to nodes index
      var halfLinksIdx = {}; // map half edge IDs to edges index
      var linksIdx = {}; // map edge IDs to edges index

      var force = d3.layout.force()
          .nodes(nodes)
          .links(links)
          .charge(-400)
          .linkDistance(linkStrength)
          .linkDistance(linkDist)
          .size([width, height])
          .on("tick",tick);

      var svg = d3.select("body").append("svg")
          .attr("width", width)
          .attr("height", height);

      var node = svg.selectAll(".node"),
          link = svg.selectAll(".link");

      function linkDist(l,li){
        return l.cost * 12
      }

      function linkStrength(l,li){
        if (l.disabled){
          return 0;
        };
        return 1;
      }

      function start() {
        link = link.data(force.links(), function(d) { return d.source.id + "-" + d.target.id; });
        link.enter().insert("line", ".node");
        link.exit().remove();

        node = node.data(force.nodes(), function(d) { return d.id;});
        node.enter().append("circle")
          .attr("fill", function(d,i) {return c20c(nodes.length);})
          .attr("class", "node")
          .attr("r", 8);
        node.exit().remove();

        force.start();
      }

      function nodeUpdate(ts,id,state) {
        console.log("nu",ts,id,state);
        if(! nodesIdx.hasOwnProperty(id)){
          let n = {"id": id};
          nodes.push(n);
          nodesIdx[id] = nodes.length - 1;
          console.log("nodes", nodes);
          console.log("nodesIdx", nodesIdx);
        };
      }

      function edgeUpdate(ts,id,edgeName,state) {
        console.log("eu",ts,id,edgeName,state);
        let estate = JSON.parse(state);
        if(!linksIdx.hasOwnProperty(edgeName)){
          if(!halfLinks.hasOwnProperty(edgeName)){
            let newhenode = nodes[nodesIdx[id]];
            let newhe = {"source": newhenode};
            halfLinks[edgeName] = newhe;
            console.log("hls", halfLinks);
          } else {
            let oldhe = halfLinks[edgeName];
            if (oldhe.source != id && !oldhe.hasOwnProperty("target")){
              let newtnode = nodes[nodesIdx[id]];
              let edata = JSON.parse(edgeName);
              let newlink = {"source": oldhe.source,"target": newtnode,"cost": edata.Cost,"disabled": estate.Disabaled};
              links.push(newlink);
              linksIdx[edgeName] = links.length - 1;
              halfLinks[edgeName] = newlink;
            };
          };
        } else {
          let aedge = links[linksIdx[edgeName]];
          aedge["disabled"] = estate.Disabled;
        };
      };

      function edgeMessage(ts,id,edgeName,dir,msgStr) {
        console.log(msgStr);
        let msg = JSON.parse(msgStr)["U"];
        console.log("em",ts,id,edgeName,dir,msg);
      }

      ws.onmessage = function(e) {
        var data = JSON.parse(e.data);
        if(data.hasOwnProperty("Type")){
          if (data["Type"] == "nodeUpdate"){
            nodeUpdate(data["T"], data["NodeID"], data["State"]);
          } else if (data["Type"] == "edgeUpdate"){
            edgeUpdate(data["T"], data["NodeID"], data["EdgeName"], data["State"]);
          } else if (data["Type"] == "edgeMessage"){
            edgeMessage(data['T'], data["NodeID"], data["EdgeName"], data["Dir"], data["Message"]);
          } else if (data["Type"] == "log"){
            console.log(data.Log);
          } else {
            console.log(data);
          }
        }
        start();
      };

      function tick() {
        node.attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; })

        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; })
            .attr("class", function(d) { return d.disable == 1? "inactiveLink" : "activeLink"; });
      };

      function run(){
        d3.xhr("/run").get(function( data ) {
          console.log("Requested run");
        });
      };

      start();
  </script>
  <div id="graph-area"></div>
  <input type="button" id="runBtn" value="Run" onclick="run()"></input>
</body>


